// 1. 설정
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
}

// --------------------------------------
// 1. 유저 (User) - 소셜 로그인 대응
// --------------------------------------
model User {
  id            String    @id @default(uuid()) // Supabase auth.users의 id와 맞추는 것을 권장
  email         String?   @unique // 소셜 로그인 시 이메일이 없을 수도 있음
  nickname      String
  profileImage  String?
  mannerTemp    Float     @default(36.5) // 매너 온도 (기본 36.5도)
  
  // 소셜 로그인 정보
  provider      Provider  // KAKAO, NAVER
  providerId    String    // 소셜 서비스에서 주는 고유 ID (식별자)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // 관계 설정
  pets          Pet[]
  posts         MatePost[]
  reviews       PlaceReview[]
  
  // 채팅 관련 (보낸 채팅, 참여한 채팅방 등)
  sentMessages  ChatMessage[]
  joinedChatRooms ChatParticipant[]

  @@unique([provider, providerId]) // 같은 소셜 계정 중복 가입 방지
}

// 소셜 로그인 제공자 Enum
enum Provider {
  KAKAO
  NAVER
  APPLE
}

// --------------------------------------
// 2. 반려동물 (Pet)
// --------------------------------------
model Pet {
  id            String    @id @default(uuid())
  name          String
  breed         String    // 견종 (예: 푸들, 말티즈)
  age           Int       // 나이 (또는 birthDate로 생년월일 관리 추천)
  weight        Float     // 몸무게 (kg) - 필터링 핵심
  gender        Gender
  isNeutered    Boolean   @default(false) // 중성화 여부
  
  // 성향 태그 (예: ["활발함", "소심함", "입질주의"])
  // Postgres는 배열 타입을 지원하므로 별도 테이블 없이 배열로 저장 가능
  personalities String[]  

  profileImage  String?
  
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

enum Gender {
  MALE
  FEMALE
}

// --------------------------------------
// 3. 장소 (Place) - 카페, 숙소 등
// --------------------------------------
model Place {
  id          String        @id @default(uuid())
  name        String
  category    PlaceCategory
  address     String
  
  // 지도 표시용 좌표
  latitude    Float
  longitude   Float

  // 핵심 필터링 정보 (컬럼으로 분리)
  isLargeDogAllowed Boolean @default(false) // 대형견 가능 여부
  isIndoor          Boolean @default(true)  // 실내 동반 가능
  isOutdoor         Boolean @default(false) // 야외 운동장 유무

  // 상세 규정은 JSON으로 유연하게 관리 (목줄 필수, 매너벨트, 입장료 등)
  petPolicy   Json?         
  
  images      String[]      // 장소 이미지 URL 배열

  posts       MatePost[]    // 이 장소에 대한 메이트 모집글들
  reviews     PlaceReview[] // 장소 후기

  createdAt   DateTime      @default(now())
}

enum PlaceCategory {
  CAFE
  RESTAURANT
  ACCOMMODATION // 숙소
  PLAYGROUND    // 운동장/공원
}

// --------------------------------------
// 4. 메이트 모집글 (MatePost)
// --------------------------------------
model MatePost {
  id          String      @id @default(uuid())
  title       String
  content     String      // "이번주 토요일 2시 같이 가실 분~"
  
  travelDate  DateTime    // 여행 날짜 및 시간
  status      PostStatus  @default(OPEN)

  // 관계: 누가(User) / 어디를(Place) 가는지
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  placeId     String
  place       Place       @relation(fields: [placeId], references: [id])

  // 이 글을 통해 생성된 채팅방
  chatRoom    ChatRoom?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

enum PostStatus {
  OPEN      // 모집중
  CLOSED    // 모집마감
  COMPLETED // 여행완료
}

// --------------------------------------
// 5. 채팅 (Chat) - 1:1 매칭
// --------------------------------------

// 채팅방 (어떤 게시글을 통해 만들어졌는지 연결)
model ChatRoom {
  id          String            @id @default(uuid())
  
  postId      String?           @unique // 게시글 하나당 하나의 메인 채팅방 (혹은 1:1이면 여러개일 수 있음. 로직에 따라 수정 가능)
  post        MatePost?         @relation(fields: [postId], references: [id])

  participants ChatParticipant[] // 채팅방 참여자들
  messages     ChatMessage[]     // 대화 내용

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}

// 채팅방 참여자 (N:M 관계 해소)
model ChatParticipant {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  chatRoomId  String
  chatRoom    ChatRoom  @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  
  joinedAt    DateTime  @default(now())

  @@unique([userId, chatRoomId]) // 유저는 한 방에 한 번만 참여 가능
}

// 실제 메시지
model ChatMessage {
  id          String    @id @default(uuid())
  content     String
  
  senderId    String
  sender      User      @relation(fields: [senderId], references: [id])
  
  chatRoomId  String
  chatRoom    ChatRoom  @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)

  isRead      Boolean   @default(false) // 읽음 처리 (MVP에선 선택)
  createdAt   DateTime  @default(now())
}

// --------------------------------------
// 6. 후기/리뷰 (PlaceReview) - P1 기능
// --------------------------------------
model PlaceReview {
  id        String   @id @default(uuid())
  rating    Int      // 1~5점
  content   String?
  images    String[]
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  placeId   String
  place     Place    @relation(fields: [placeId], references: [id])

  createdAt DateTime @default(now())
}